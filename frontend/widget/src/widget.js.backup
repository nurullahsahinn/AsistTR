/**
 * AsistTR Chat Widget
 * Web sitelerine gÃ¶mÃ¼lebilir canlÄ± destek widget'Ä±
 */

import { io } from 'socket.io-client'

(function() {
  'use strict';

  const API_URL = 'http://localhost:4000'
  const WS_URL = 'http://localhost:4000'
  
  // Global config'den API key al
  const API_KEY = window.AsistTRConfig?.apiKey || ''
  
  if (!API_KEY) {
    console.error('AsistTR: API key bulunamadÄ±! window.AsistTRConfig.apiKey ayarlamanÄ±z gerekiyor.')
    return
  }
  
  console.log('AsistTR Widget baÅŸlatÄ±lÄ±yor...', { API_KEY })

  // Session ID oluÅŸtur veya al
  let sessionId = localStorage.getItem('asistr_session_id')
  if (!sessionId) {
    sessionId = 'session_' + Math.random().toString(36).substr(2, 9)
    localStorage.setItem('asistr_session_id', sessionId)
  }

  let socket = null
  let conversationId = null
  let visitorId = null
  let isOpen = false

  // Widget HTML
  const widgetHTML = `
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
      
      :root {
        --primary-color: #f2480b;
        --primary-light: #ff6633;
        --primary-dark: #d13c00;
        --dark-bg: #090c10;
        --dark-secondary: #151b25;
        --glass-bg: rgba(255, 255, 255, 0.05);
        --glass-border: rgba(255, 255, 255, 0.1);
        --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      }
      
      #asistr-widget {
        position: fixed;
        bottom: 20px;
        right: 20px;
        font-family: 'Poppins', sans-serif;
        z-index: 99999;
      }

      #asistr-bubble {
        width: 65px;
        height: 65px;
        background: linear-gradient(135deg, rgba(242, 72, 11, 0.9) 0%, rgba(209, 60, 0, 0.9) 100%);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        border: 2px solid rgba(242, 72, 11, 0.3);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-center;
        cursor: pointer;
        box-shadow: 0 8px 24px rgba(242, 72, 11, 0.4), 
                    inset 0 1px 0 rgba(255, 255, 255, 0.2);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
        position: relative;
      }
      
      #asistr-bubble::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        transform: rotate(45deg);
        transition: all 0.6s;
      }
      
      #asistr-bubble:hover::before {
        left: 100%;
      }

      #asistr-bubble:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(0,0,0,0.2);
      }

      #asistr-bubble svg {
        width: 28px;
        height: 28px;
        fill: white;
      }

      #asistr-chat-window {
        position: fixed;
        bottom: 100px;
        right: 20px;
        width: 380px;
        height: 550px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 12px 48px rgba(0,0,0,0.2);
        display: none;
        flex-direction: column;
        overflow: hidden;
        animation: slideUp 0.3s ease-out;
      }

      @keyframes slideUp {
        from {
          transform: translateY(20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      #asistr-chat-window.open {
        display: flex;
      }

      #asistr-header {
        background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
        color: white;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      #asistr-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
      }

      #asistr-header p {
        margin: 4px 0 0 0;
        font-size: 12px;
        opacity: 0.9;
      }

      #asistr-close {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-center;
        font-size: 20px;
      }

      #asistr-close:hover {
        background: rgba(255,255,255,0.3);
      }

      #asistr-welcome-form {
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      #asistr-welcome-form input {
        padding: 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        outline: none;
        transition: border-color 0.2s;
      }

      #asistr-welcome-form input:focus {
        border-color: #0284c7;
      }

      #asistr-welcome-form button {
        padding: 12px;
        background: #0284c7;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
      }

      #asistr-welcome-form button:hover {
        background: #0369a1;
      }

      #asistr-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f9fafb;
        display: none;
      }

      #asistr-messages.active {
        display: block;
      }

      .asistr-message {
        margin-bottom: 16px;
        display: flex;
        gap: 8px;
      }

      .asistr-message.visitor {
        justify-content: flex-end;
      }

      .asistr-message-bubble {
        max-width: 70%;
        padding: 10px 14px;
        border-radius: 16px;
        font-size: 14px;
        line-height: 1.4;
      }

      .asistr-message.agent .asistr-message-bubble {
        background: white;
        color: #1f2937;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      }

      .asistr-message.visitor .asistr-message-bubble {
        background: #0284c7;
        color: white;
      }

      .asistr-message-time {
        font-size: 11px;
        opacity: 0.7;
        margin-top: 4px;
      }

      #asistr-input-area {
        padding: 16px;
        border-top: 1px solid #e5e7eb;
        background: white;
        display: none;
      }

      #asistr-input-area.active {
        display: block;
      }

      #asistr-input-form {
        display: flex;
        gap: 8px;
      }

      #asistr-message-input {
        flex: 1;
        padding: 10px 14px;
        border: 1px solid #e5e7eb;
        border-radius: 20px;
        font-size: 14px;
        outline: none;
        resize: none;
        max-height: 100px;
      }

      #asistr-message-input:focus {
        border-color: #0284c7;
      }

      #asistr-send-btn {
        width: 40px;
        height: 40px;
        background: #0284c7;
        border: none;
        border-radius: 50%;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-center;
        transition: background 0.2s;
      }

      #asistr-send-btn:hover {
        background: #0369a1;
      }

      #asistr-send-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }

      .asistr-typing {
        display: inline-block;
        padding: 10px 14px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      }

      .asistr-typing span {
        display: inline-block;
        width: 8px;
        height: 8px;
        background: #9ca3af;
        border-radius: 50%;
        margin: 0 2px;
        animation: typing 1.4s infinite;
      }

      .asistr-typing span:nth-child(2) {
        animation-delay: 0.2s;
      }

      .asistr-typing span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-10px); }
      }

      ::-webkit-scrollbar {
        width: 6px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }

      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }
    </style>

    <div id="asistr-widget">
      <!-- Chat Bubble -->
      <div id="asistr-bubble">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
        </svg>
      </div>

      <!-- Chat Window -->
      <div id="asistr-chat-window">
        <div id="asistr-header">
          <div>
            <h3>AsistTR</h3>
            <p>CanlÄ± Destek</p>
          </div>
          <button id="asistr-close">Ã—</button>
        </div>

        <!-- Welcome Form -->
        <div id="asistr-welcome-form">
          <h4 style="margin: 0 0 8px 0; color: #1f2937;">HoÅŸ geldiniz! ðŸ‘‹</h4>
          <p style="margin: 0 0 16px 0; color: #6b7280; font-size: 14px;">Size nasÄ±l yardÄ±mcÄ± olabiliriz?</p>
          <input type="text" id="asistr-name" placeholder="AdÄ±nÄ±z" required />
          <input type="email" id="asistr-email" placeholder="E-posta (opsiyonel)" />
          <button id="asistr-start-chat">Sohbet BaÅŸlat</button>
        </div>

        <!-- Messages Area -->
        <div id="asistr-messages"></div>

        <!-- Input Area -->
        <div id="asistr-input-area">
          <form id="asistr-input-form">
            <textarea 
              id="asistr-message-input" 
              placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." 
              rows="1"
            ></textarea>
            <button type="submit" id="asistr-send-btn">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
              </svg>
            </button>
          </form>
        </div>
      </div>
    </div>
  `

  // Widget'Ä± DOM'a ekle
  function initWidget() {
    const widgetContainer = document.createElement('div')
    widgetContainer.innerHTML = widgetHTML
    document.body.appendChild(widgetContainer)

    // Event listener'lar
    document.getElementById('asistr-bubble').addEventListener('click', toggleChat)
    document.getElementById('asistr-close').addEventListener('click', toggleChat)
    document.getElementById('asistr-start-chat').addEventListener('click', startChat)
    document.getElementById('asistr-input-form').addEventListener('submit', sendMessage)
    
    // Enter tuÅŸu ile gÃ¶nder
    document.getElementById('asistr-message-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault()
        sendMessage(e)
      }
    })
  }

  function toggleChat() {
    const chatWindow = document.getElementById('asistr-chat-window')
    isOpen = !isOpen
    
    if (isOpen) {
      chatWindow.classList.add('open')
    } else {
      chatWindow.classList.remove('open')
    }
  }

  function startChat() {
    const name = document.getElementById('asistr-name').value.trim()
    const email = document.getElementById('asistr-email').value.trim()

    if (!name) {
      alert('LÃ¼tfen adÄ±nÄ±zÄ± girin')
      return
    }

    // Socket baÄŸlantÄ±sÄ± kur
    connectSocket({ name, email })

    // UI'yi deÄŸiÅŸtir
    document.getElementById('asistr-welcome-form').style.display = 'none'
    document.getElementById('asistr-messages').classList.add('active')
    document.getElementById('asistr-input-area').classList.add('active')

    addMessage('agent', `Merhaba ${name}! Size nasÄ±l yardÄ±mcÄ± olabilirim?`)
  }

  function connectSocket(visitorInfo) {
    socket = io(WS_URL, {
      transports: ['websocket', 'polling']
    })

    socket.on('connect', () => {
      console.log('Socket baÄŸlandÄ±:', socket.id)
      
      socket.emit('visitor:connect', {
        apiKey: API_KEY,
        sessionId,
        visitorInfo
      })
    })

    socket.on('visitor:connected', (data) => {
      conversationId = data.conversationId
      visitorId = data.visitorId
      console.log('Conversation baÅŸlatÄ±ldÄ±:', conversationId)
    })

    socket.on('message:received', (message) => {
      if (message.senderType === 'agent' || message.senderType === 'bot') {
        addMessage('agent', message.body)
      }
    })

    socket.on('typing:agent', () => {
      showTyping()
    })

    socket.on('typing:stop', () => {
      hideTyping()
    })

    socket.on('disconnect', () => {
      console.log('Socket baÄŸlantÄ±sÄ± kesildi')
    })
  }

  function sendMessage(e) {
    e.preventDefault()
    
    const input = document.getElementById('asistr-message-input')
    const message = input.value.trim()

    if (!message || !socket || !conversationId) return

    // MesajÄ± gÃ¶nder
    socket.emit('message:send', {
      conversationId,
      body: message,
      senderType: 'visitor'
    })

    // UI'ye ekle
    addMessage('visitor', message)
    input.value = ''
    input.style.height = 'auto'
  }

  function addMessage(type, text) {
    const messagesContainer = document.getElementById('asistr-messages')
    const messageDiv = document.createElement('div')
    messageDiv.className = `asistr-message ${type}`
    
    const now = new Date()
    const time = now.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })
    
    messageDiv.innerHTML = `
      <div class="asistr-message-bubble">
        <div>${text}</div>
        <div class="asistr-message-time">${time}</div>
      </div>
    `
    
    messagesContainer.appendChild(messageDiv)
    messagesContainer.scrollTop = messagesContainer.scrollHeight
  }

  function showTyping() {
    const messagesContainer = document.getElementById('asistr-messages')
    const typingDiv = document.createElement('div')
    typingDiv.id = 'asistr-typing-indicator'
    typingDiv.className = 'asistr-message agent'
    typingDiv.innerHTML = `
      <div class="asistr-typing">
        <span></span>
        <span></span>
        <span></span>
      </div>
    `
    messagesContainer.appendChild(typingDiv)
    messagesContainer.scrollTop = messagesContainer.scrollHeight
  }

  function hideTyping() {
    const typingIndicator = document.getElementById('asistr-typing-indicator')
    if (typingIndicator) {
      typingIndicator.remove()
    }
  }

  // Widget'Ä± baÅŸlat
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initWidget)
  } else {
    initWidget()
  }

})();

